<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Bioinfor | 牛牛龙]]></title>
  <link href="http://yulongniu.bionutshell.org/blog/categories/bioinfor/atom.xml" rel="self"/>
  <link href="http://yulongniu.bionutshell.org/"/>
  <updated>2016-09-01T16:20:34+08:00</updated>
  <id>http://yulongniu.bionutshell.org/</id>
  <author>
    <name><![CDATA[Yulong Niu]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[UCSC Table下载注释文件]]></title>
    <link href="http://yulongniu.bionutshell.org/blog/2015/06/02/download-ucsc-gene-mask/"/>
    <updated>2015-06-02T16:49:41+08:00</updated>
    <id>http://yulongniu.bionutshell.org/blog/2015/06/02/download-ucsc-gene-mask</id>
    <content type="html"><![CDATA[<p>在进行RNA-seq数据分析时，需要从<a href="http://genome.ucsc.edu/cgi-bin/hgTables">UCSC Table</a>下载各种注释信息。比如Cufflinks等要求的转录组注释信息、Cufflinks建议去除的rRNA/tRNA/线粒体组注释。</p>

<h2 id="section">1. 基因注释信息</h2>

<p>下载转录组Ensembl注释文件：</p>

<p><img src="http://yulongniu.bionutshell.org/images/hg19_ensembl.png" title="image" alt="UCSC下载Ensembl注释" /></p>

<!--more-->

<p>在“table”选择中，<code class="language-bash">ensemblSource</code>表示Ensembl类型注释，<code class="language-bash">ensemblToGeneName</code>表示Ensembl到基因名注释对应。</p>

<h2 id="rrna">2. rRNA注释信息</h2>

<p>分为两步：</p>

<p>第一步， “table”选择<code class="language-bash">wgEncodeGencodeBasicV19</code>。</p>

<p><img src="http://yulongniu.bionutshell.org/images/hg19_rRNA.png" title="image" alt="UCSC下载rRNA注释" /></p>

<p>第二步，按照下图编辑“filter”。</p>

<p><img src="http://yulongniu.bionutshell.org/images/hg19_rRNA_maskTable.png" title="image" alt="UCSC下载rRNA注释Table" /></p>

<p><img src="http://yulongniu.bionutshell.org/images/hg19_rRNA_mask.png" title="image" alt="UCSC下载rRNA注释筛选" /></p>

<h2 id="trna">3. tRNA注释信息</h2>

<p>分为两步：</p>

<p>第一步，“track”选择 <code class="language-bash">tRNA Genes</code>。</p>

<p><img src="http://yulongniu.bionutshell.org/images/hg19_tRNA.png" title="image" alt="UCSC下载tRNA注释" /></p>

<p>第二步，保留pseudo tRNA注释。</p>

<p><img src="http://yulongniu.bionutshell.org/images/hg19_tRNA_mask.png" title="image" alt="UCSC下载tRNA注释" /></p>

<h2 id="section-1">4. 线粒体基因组注释</h2>

<p>分为两步：</p>

<p>第一步， “table”选择<code class="language-bash">wgEncodeGencodeBasicV19</code>。</p>

<p><img src="http://yulongniu.bionutshell.org/images/hg19_chrM.png" title="image" alt="UCSC下载chrM注释" /></p>

<p>第二步，按照下图编辑“filter”。</p>

<p><img src="http://yulongniu.bionutshell.org/images/hg19_chrM_mask.png" title="image" alt="UCSC下载chrM注释筛选" /></p>

<h3 id="section-2">参考资料</h3>

<ul>
  <li>
    <p>USCS Genome Browser的Google论坛：<a href="https://groups.google.com/a/soe.ucsc.edu/forum/#!topic/genome/IL_aeOuPYU0">1</a>、<a href="https://groups.google.com/a/soe.ucsc.edu/forum/#!msg/genome/jSAY8w1JVVo/P6lk4OJzDNEJ">2</a></p>
  </li>
  <li>
    <p>另一种选择rRNA、tRNA和线粒体组注释的方法<a href="http://onetipperday.blogspot.tw/2012/08/how-to-get-trnarrnamitochondrial-gene.html">How to get tRNA/rRNA/mitochondrial gene GTF file</a></p>
  </li>
  <li>
    <p><a href="http://webappl.blogspot.tw/2015/02/extract-rrna-and-trna-features-from.html">Extract rRNA and tRNA features from UCSC Browser</a></p>
  </li>
</ul>

<h3 id="section-3">更新记录</h3>

<p>2015年6月1日</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[确定TopHat中mate-inner-dist参数]]></title>
    <link href="http://yulongniu.bionutshell.org/blog/2015/05/23/tophat-inner-distance/"/>
    <updated>2015-05-23T19:08:19+08:00</updated>
    <id>http://yulongniu.bionutshell.org/blog/2015/05/23/tophat-inner-distance</id>
    <content type="html"><![CDATA[<p>对于双端测序RNA-seq数据，TopHat在运行时候，有两个参数<code class="language-bash">-r/--mate-inner-dist</code>和<code class="language-bash">--mate-std-dev</code>分别标识一对reads的间隔长度的期望平均值和标准差，其默认值分别为50bp和20bp。这两个参数本身是个估计值，用于TopHat在map过程中确定一对reads是否匹配到基因组正确位置。如果能够准确设定这两个数值，将会提升TopHat结果的准确性和完整性，参考<a href="http://yulongniu.bionutshell.org/blog/2014/07/23/rna-seq-analysis/">一个例子</a>。</p>

<p>有两种方法获得这对参数的准确值：</p>

<p>第一种：获取RNA-seq实验建库方法，之后按照以下网址说明计算，<a href="http://blog.qiuworld.com:8080/archives/3007">RNA-seq差异表达分析工作流程</a>。</p>

<!--more-->

<p>第二种：根据RNA-seq数据进行估算，具体步骤为：</p>

<ol>
  <li>
    <p>使用TopHat默认参数先跑一遍。</p>
  </li>
  <li>
    <p>使用<a href="http://miso.readthedocs.org/en/fastmiso/#computing-the-insert-length-distribution-and-its-statistics">MISO</a>的<code class="language-bash">pe_utils</code>工具估算。</p>
  </li>
</ol>

<p>以下详细介绍<code class="language-bash">pe_utils</code>使用方法。</p>

<p>第一步， 下载对应物种的基因注释文件GTF或者GFF，比如<a href="http://genome.ucsc.edu/cgi-bin/hgTables?command=start">USCS Table Browser</a>（<code class="language-bash">output format</code>选择<code class="language-bash">GTF</code>）或者使用MISO提供的<a href="http://miso.readthedocs.org/en/fastmiso/#human-mouse-gene-models-for-isoform-centric-analyses">Ensembl版本</a>。如果GTF文件，使用<a href="https://cole-trapnell-lab.github.io/cufflinks/file_formats/">Cufflinks</a>的<code class="language-bash">gffread</code>工具进行转换。</p>

<p>第二步，确定TopHat运行结果的bam文件与基因注释GFF文件，两者基因组命名方法一致。有的使用类似<code class="language-bash">chr1</code>命名，而另外一些使用<code class="language-bash">1</code>。如果不一致，建议修改GFF文件。</p>

<p><figure class='code'><figcaption><span>Summary Chromosomes’ Names</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># 查看GFF文件中基因组命名</span>
</span><span class='line'><span class="nv">$ </span>awk ‘<span class="o">{</span>print <span class="nv">$1</span><span class="o">}</span>’ hg19USCS.gff <span class="p">|</span> sort -n <span class="p">|</span> uniq -c&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;bam&quot;</span>&gt;查看bam文件中基因组命名&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;samtools view accepted_hits.bam <span class="p">|</span> head -1000 <span class="p">|</span> awk ‘<span class="o">{</span>print <span class="nv">$3</span><span class="o">}</span>’ <span class="p">|</span> sort -n <span class="p">|</span> uniq -c
</span></code></pre></td></tr></table></div></figure></p>

<p>第三步，筛选较长外显子，比如长度大于1000bp。MISO提供了<code class="language-bash">exon_utils</code>工具用于提取长外显子，但是我们没有能够成功运行过。因此这里提供一个R版本的脚本，比如基因注释文件名为<code class="language-bash">hg19USCS.gff</code>，输出筛选的文件名为<code class="language-bash">hg19USCS_selected.gff</code>。</p>

<p><figure class='code'><figcaption><span>R Script of Select exons with length &gt; 1000bp</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='R'><span class='line'>gffFile <span class="o">&amp;</span>lt<span class="p">;</span><span class="o">-</span> read.table<span class="p">(</span>‘hg19USCS.gff’<span class="p">,</span> stringsAsFactors <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span><span class="o">&lt;/</span>p<span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span>p<span class="o">&gt;</span>gffExon <span class="o">&amp;</span>lt<span class="p">;</span><span class="o">-</span> gffFile<span class="p">[</span>gffFile<span class="p">[,</span> <span class="m">3</span><span class="p">]</span> <span class="o">==</span> ‘exon’<span class="p">,</span> <span class="p">]</span><span class="o">&lt;/</span>p<span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span>p<span class="o">&gt;</span>exonLen <span class="o">&amp;</span>lt<span class="p">;</span><span class="o">-</span> <span class="kp">abs</span><span class="p">(</span>gffExon<span class="p">[,</span> <span class="m">5</span><span class="p">]</span> <span class="o">-</span> gffExon<span class="p">[,</span> <span class="m">4</span><span class="p">])</span><span class="o">&lt;/</span>p<span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span>p<span class="o">&gt;</span>gffExonSelect <span class="o">&amp;</span>lt<span class="p">;</span><span class="o">-</span> gffExon<span class="p">[</span>exonLen <span class="o">&amp;</span>gt<span class="p">;</span><span class="o">=</span> <span class="m">1000</span><span class="p">,</span> <span class="p">]</span><span class="o">&lt;/</span>p<span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span>p<span class="o">&gt;</span>write.table<span class="p">(</span>gffExonSelect<span class="p">,</span> ‘hg19USCS_selected.gff’<span class="p">,</span>
</span><span class='line'>            row.names <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> col.names <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span>
</span><span class='line'>            quote <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> sep <span class="o">=</span> ‘\<span class="kp">t</span>’<span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>第四步，使用<code class="language-bash">pe_utils</code>，实例如下：</p>

<p><figure class='code'><figcaption><span>An example of how to use pe_utils</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># 输入bam文件和GFF文件</span>
</span><span class='line'><span class="nv">$ </span>pe_utils –compute-insert-len accepted_hits.bam hg19USCS_selected.gff –output-dir insert-dist/&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;insert-distacceptedfilteredbaminsertlen&quot;</span>&gt;在insert-dist会出现类似accepted_filtered.bam.insert_len文件&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;# -r/–mate-inner-dist估计值为mean
</span><span class='line'><span class="c"># –mate-std-dev估计值为sdev</span>
</span><span class='line'><span class="nv">$ </span>head -1 accepted_filtered.bam.insert_len
</span><span class='line'><span class="c">#mean=165.3,sdev=45.2,dispersion=3.5,num_pairs=5622239</span>
</span></code></pre></td></tr></table></div></figure></p>

<h3 id="section">更新记录</h3>

<p>2015年5月23日</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[过滤TopHat分析双端测序的输出]]></title>
    <link href="http://yulongniu.bionutshell.org/blog/2015/05/16/filter-tophat2-output/"/>
    <updated>2015-05-16T04:33:10+08:00</updated>
    <id>http://yulongniu.bionutshell.org/blog/2015/05/16/filter-tophat2-output</id>
    <content type="html"><![CDATA[<script type="text/x-mathjax-config">
MathJax.Hub.Config({
TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

<h2 id="section">0. 结论</h2>

<p>在使用TopHat2匹配双端测序结果后，建议根据成对reads的map基因组位置唯一、方向正确和距离合适的标准，筛选得到的匹配结果。比如，TopHat2可能生成<code class="language-bash">accepted_hits.bam</code>文件，处理方法如下：</p>

<p><figure class='code'><figcaption><span>Filter TopHat Outputs</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;bam&quot;</span>&gt;首先查看bam文件头部有多少行&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;<span class="nv">$ </span>samtools view -H accepted_hits.bam <span class="p">|</span> wc -l
</span><span class='line'>86&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;mapreadsnr--86&quot;</span>&gt;筛选成对且成功map到基因组唯一位置的reads，按照上一条输出结果，调整“NR <span class="p">&amp;</span>lt<span class="p">;</span><span class="o">=</span> 86”&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;<span class="nv">$ </span>samtools view -h accepted_hits.bam <span class="p">|</span> <span class="se">\</span>
</span><span class='line'>    awk ‘<span class="o">{</span><span class="k">if</span> <span class="o">(</span>NR <span class="p">&amp;</span>lt<span class="p">;</span><span class="o">=</span> 86<span class="o">)</span> print <span class="nv">$0</span><span class="o">}</span><span class="p">;</span> <span class="o">{</span><span class="k">if</span><span class="o">(</span><span class="nv">$5</span> <span class="o">==</span> <span class="m">50</span> <span class="p">&amp;</span>amp<span class="p">;&amp;</span>amp<span class="p">;</span> <span class="o">(</span><span class="nv">$2</span> <span class="o">==</span> <span class="m">163</span> <span class="o">||</span> <span class="nv">$2</span> <span class="o">==</span> <span class="m">147</span> <span class="o">||</span> <span class="nv">$2</span> <span class="o">==</span> <span class="m">83</span> <span class="o">||</span> <span class="nv">$2</span> <span class="o">==</span> 99<span class="o">))</span> print <span class="nv">$0</span><span class="o">}</span>’ <span class="p">|</span> <span class="se">\</span>
</span><span class='line'>    samtools view -b - <span class="p">&amp;</span>gt<span class="p">;</span> accepted_filtered.bam&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="nv">$ </span>samtools view accepted_filtered.bam <span class="p">|</span> wc -l
</span><span class='line'>79143942
</span></code></pre></td></tr></table></div></figure></p>

<h2 id="tophatsam">1. TopHat输出sam文件的第五列</h2>

<p><a href="http://ccb.jhu.edu/software/tophat/manual.shtml">TopHat文档</a>没有解释其输出bam文件（比如<code class="language-bash">accepted_hits.bam</code>）的第五列的意义。按照<a href="http://bowtie-bio.sourceforge.net/bowtie2/index.shtml">Bowtie2</a>输出结果来看，是表示映射质量指标Mapping Quality scores（MAPQ），具体计算参考公式$\eqref{eq:1}$。</p>

<script type="math/tex; mode=display">\begin{align}
MAPQ = -10 \times log_{10}(pvalue)
\label{eq:1}
\end{align}</script>

<!--more-->

<p>MAPQ值越大，表示对应的read的alignment质量越高。然而，在TopHat输出结果中，MAPQ所代表意义略有不同。</p>

<p><figure class='code'><figcaption><span>“MAPQ” distribution from TopHat2 accepted mapping reads</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># 查看accepted_hits.bam文件的MAPQ数值，并统计出现频数</span>
</span><span class='line'><span class="nv">$ </span>samtools view accepted_hits.bam <span class="p">|</span> awk ‘<span class="o">{</span>print <span class="nv">$5</span><span class="o">}</span>’ <span class="p">|</span> sort –parallel<span class="o">=</span><span class="m">4</span> -n <span class="p">|</span> uniq -c
</span><span class='line'><span class="m">5057430</span> 0
</span><span class='line'><span class="m">3117731</span> 1
</span><span class='line'><span class="m">8058500</span> 3
</span><span class='line'><span class="m">93044727</span> 50&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;mapqnhin&quot;</span>&gt;查看前100位MAPQ数值和NH:i:n分布&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;<span class="nv">$ </span>samtools view accepted_hits.bam <span class="p">|</span> awk ‘<span class="o">{</span>print <span class="nv">$5</span><span class="o">}</span>’ <span class="p">|</span> head -100 <span class="p">|</span> sort –parallel<span class="o">=</span><span class="m">4</span> -n <span class="p">|</span> uniq -c
</span><span class='line'><span class="m">35</span> 0
</span><span class='line'><span class="m">42</span> 1
</span><span class='line'><span class="m">22</span> 3
</span><span class='line'><span class="m">1</span> 50&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="nv">$ </span>samtools view accepted_hits.bam <span class="p">|</span> awk ‘<span class="o">{</span>print <span class="nv">$20</span><span class="o">}</span>’ <span class="p">|</span> head -100 <span class="p">|</span> sort –parallel<span class="o">=</span><span class="m">4</span> -n <span class="p">|</span> uniq -c
</span><span class='line'><span class="m">1</span> NH:i:1
</span><span class='line'><span class="m">22</span> NH:i:2
</span><span class='line'><span class="m">3</span> NH:i:20
</span><span class='line'><span class="m">13</span> NH:i:3
</span><span class='line'><span class="m">29</span> NH:i:4
</span><span class='line'><span class="m">5</span> NH:i:5
</span><span class='line'><span class="m">21</span> NH:i:6
</span><span class='line'><span class="m">1</span> NH:i:7
</span><span class='line'><span class="m">2</span> NH:i:8
</span><span class='line'><span class="m">3</span> NH:i:9&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;mapqnhin-1&quot;</span>&gt;查看前200位MAPQ数值和NH:i:n分布&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;<span class="nv">$ </span>samtools view accepted_hits.bam <span class="p">|</span> awk ‘<span class="o">{</span>print <span class="nv">$5</span><span class="o">}</span>’ <span class="p">|</span> head -200 <span class="p">|</span> sort –parallel<span class="o">=</span><span class="m">4</span> -n <span class="p">|</span> uniq -c
</span><span class='line'><span class="m">60</span> 0
</span><span class='line'><span class="m">43</span> 1
</span><span class='line'><span class="m">67</span> 3
</span><span class='line'><span class="m">30</span> 50&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="nv">$ </span>samtools view accepted_hits.bam <span class="p">|</span> awk ‘<span class="o">{</span>print <span class="nv">$20</span><span class="o">}</span>’ <span class="p">|</span> head -200 <span class="p">|</span> sort –parallel<span class="o">=</span><span class="m">4</span> -n <span class="p">|</span> uniq -c
</span><span class='line'><span class="m">30</span> NH:i:1
</span><span class='line'><span class="m">8</span> NH:i:12
</span><span class='line'><span class="m">7</span> NH:i:14
</span><span class='line'><span class="m">67</span> NH:i:2
</span><span class='line'><span class="m">3</span> NH:i:20
</span><span class='line'><span class="m">13</span> NH:i:3
</span><span class='line'><span class="m">30</span> NH:i:4
</span><span class='line'><span class="m">5</span> NH:i:5
</span><span class='line'><span class="m">31</span> NH:i:6
</span><span class='line'><span class="m">1</span> NH:i:7
</span><span class='line'><span class="m">2</span> NH:i:8
</span><span class='line'><span class="m">3</span> NH:i:9
</span></code></pre></td></tr></table></div></figure></p>

<p>首先，我们可以看到TopHat输出的MAPQ只有四个数值，分别为<code class="language-bash">50</code>、<code class="language-bash">3</code>、<code class="language-bash">1</code>和<code class="language-bash">0</code>。根据<a href="http://samtools.github.io/hts-specs/SAMv1.pdf">sam文件标准</a>，<code class="language-bash">NH:i:n</code>表示含有查询序列的alignment的数量。因此，通过上述前100位和前200位分析可以发现，MAPQ并不是按照公式$\eqref{eq:1}$计算，而有可能是以下关系：</p>

<hr />

<table>
  <thead>
    <tr>
      <th style="text-align: left">MAPQ (tophat)</th>
      <th style="text-align: center">Tag</th>
      <th style="text-align: right">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">50</td>
      <td style="text-align: center">NH:i:1</td>
      <td style="text-align: right">map至唯一位置</td>
    </tr>
    <tr>
      <td style="text-align: left">3</td>
      <td style="text-align: center">NH:i:2</td>
      <td style="text-align: right">map至2个位置</td>
    </tr>
    <tr>
      <td style="text-align: left">1</td>
      <td style="text-align: center">NH:i:3/NH:i:4</td>
      <td style="text-align: right">map至3个或4个位置</td>
    </tr>
    <tr>
      <td style="text-align: left">0</td>
      <td style="text-align: center">NH:i:n (n &gt; 4)</td>
      <td style="text-align: right">map到多余4个位置</td>
    </tr>
  </tbody>
</table>

<hr />

<p>展示一个<code class="language-bash">NH:i:1</code>的例子，注意Illumina双端测序平台<code class="language-bash">fr-unstranded</code>：</p>

<p><figure class='code'><figcaption><span>Two pairs of unique mapped reads from Illumina HiSeq2000 </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>HISEQ2000-02:436:C2PG3ACXX:3:2313:10972:95322   <span class="m">163</span>     chr1    <span class="m">637224</span>  <span class="m">50</span>      <span class="nv">100M</span>    <span class="o">=</span>       <span class="m">637339</span>  <span class="m">215</span>     AAATGATCTGTACAATAACCCCCTGTGACACCAGTCTACCTATGTAACAAATGCCCCTAAACTTAAAATAAAAGTTAAAAAAAAAGAAAATTAAAATCTC  <span class="p">&amp;</span>lt<span class="p">;</span>@@BDABBDFBCDGEGHIGIIGIABAFHBGDFGGGHIIIFIEIGGGGIIIFFDHIGIIIIIIIICEHIIIIIIHEHHDHFFCBCCB@BCAACCCCCECCC    AS:i:0  XN:i:0  XM:i:0  XO:i:0  XG:i:0  NM:i:0  MD:Z:100     YT:Z:UU  NH:i:1
</span><span class='line'>HISEQ2000-02:436:C2PG3ACXX:3:2313:10972:95322   <span class="m">83</span>      chr1    <span class="m">637339</span>  <span class="m">50</span>      <span class="nv">100M</span>    <span class="o">=</span>       <span class="m">637224</span>  -215    GTAATATGAAAAACACAAATCTTTCATTCATTCCTTTCAACTGATGAGGAAAATGAGGCATCGGGAGTTAGTAAAAGTCCACATTGAGATATGAGACCCA  <span class="nv">CCADDDCCCCCCCDEEEECAEHEEGGIIHGFAAGGGHEF</span><span class="o">=</span>IGGGIIGGHGCGIEIIIGIIIIIIIFIHIIIIIIGIIHFEAIGGIIGFFDFHDDDAD@@@    AS:i:0  XN:i:0  XM:i:0  XO:i:0  XG:i:0  NM:i:0  MD:Z:100     YT:Z:UU  NH:i:1&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;HISEQ2000-06:325:C2RC0ACXX:5:2205:6961:88285    <span class="m">99</span>      chr1    <span class="m">643662</span>  <span class="m">50</span>      <span class="nv">100M</span>    <span class="o">=</span>       <span class="m">643707</span>  <span class="m">145</span>     CCTATCAAAATCTTAGCATTCCTCTTAGCCCTCAACAAAGCATTTCTAAAATGTGTATAGAAGACCAAAGGGCCAAAAGAGTCAACTTCTGAAGAAGCGC  CCCFFFFFHHHHHJJJJIJJHJJJJJJJIIJJJJJJJJJJJJIJJJJJIIIJJIIIJJJJJJJJJIJJJJIJJJIHHHHFFEFFFEEEEEEEDDCDDCDD    AS:i:0  XN:i:0  XM:i:0  XO:i:0  XG:i:0  NM:i:0  MD:Z:100     YT:Z:UU  NH:i:1
</span><span class='line'>HISEQ2000-06:325:C2RC0ACXX:5:2205:6961:88285    <span class="m">147</span>     chr1    <span class="m">643707</span>  <span class="m">50</span>      <span class="nv">100M</span>    <span class="o">=</span>       <span class="m">643662</span>  -145    CTAAAATGTGTATAGAAGACCAAAGGGCCAAAAGAGTCAACTTCTGAAGAAGCGCAAAAAGAAAGTTGAGGAAATCTTAAAACATGTTATTGAGCTTAAA  CEEEDDDDEDFEEEEEEEBFFFFFHHHHEJJJJJJJJIJJJJGJIIIIHFJJJIIJJJJJIJJJJJJJJJJJJGHJJJJIJJJJJJJGHHHHFFFFFCCC    AS:i:0  XN:i:0  XM:i:0  XO:i:0  XG:i:0  NM:i:0  MD:Z:100     YT:Z:UU  NH:i:1
</span></code></pre></td></tr></table></div></figure></p>

<h2 id="sam">2. sam文件的第二列</h2>

<p>sam文件中的第二列提供了具体的map情况，下列表格摘自<a href="http://samtools.github.io/hts-specs/SAMv1.pdf">sam文件标准</a>，sam/bam文件中第二列各种条件<strong>求和</strong>的<strong>十进制</strong>标识，<a href="http://broadinstitute.github.io/picard/explain-flags.html">快速解释第二列的bitwise FLAG</a>：</p>

<hr />

<table>
  <thead>
    <tr>
      <th style="text-align: center">Decimal</th>
      <th style="text-align: center">Hexadecimal</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center">0x1</td>
      <td style="text-align: left">template having multiple segments in sequencing</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center">0x2</td>
      <td style="text-align: left">each segment properly aligned according to the aligner</td>
    </tr>
    <tr>
      <td style="text-align: center">4</td>
      <td style="text-align: center">0x4</td>
      <td style="text-align: left">segment unmapped</td>
    </tr>
    <tr>
      <td style="text-align: center">8</td>
      <td style="text-align: center">0x8</td>
      <td style="text-align: left">next segment in the template unmapped</td>
    </tr>
    <tr>
      <td style="text-align: center">16</td>
      <td style="text-align: center">0x10</td>
      <td style="text-align: left">SEQ being reverse complemented</td>
    </tr>
    <tr>
      <td style="text-align: center">32</td>
      <td style="text-align: center">0x20</td>
      <td style="text-align: left">SEQ of the next segment in the template being reverse complemented</td>
    </tr>
    <tr>
      <td style="text-align: center">64</td>
      <td style="text-align: center">0x40</td>
      <td style="text-align: left">the first segment in the template</td>
    </tr>
    <tr>
      <td style="text-align: center">128</td>
      <td style="text-align: center">0x80</td>
      <td style="text-align: left">the last segment in the template</td>
    </tr>
    <tr>
      <td style="text-align: center">256</td>
      <td style="text-align: center">0x100</td>
      <td style="text-align: left">secondary alignment</td>
    </tr>
    <tr>
      <td style="text-align: center">512</td>
      <td style="text-align: center">0x200</td>
      <td style="text-align: left">not passing quality controls</td>
    </tr>
    <tr>
      <td style="text-align: center">1024</td>
      <td style="text-align: center">0x400</td>
      <td style="text-align: left">PCR or optical duplicate</td>
    </tr>
    <tr>
      <td style="text-align: center">2048</td>
      <td style="text-align: center">0x800</td>
      <td style="text-align: left">supplementary alignment</td>
    </tr>
  </tbody>
</table>

<hr />

<p>在map完成双端测序序列中，我们感兴趣的是一对reads都正确align到基因组上，而且方相匹配又距离合适。符合这样条件的reads，对应的第二列数值为99、147、83和163，具体图示参考<a href="https://biobeat.wordpress.com/2013/04/29/directional-rna-seq-part-1-extract-strand-information-from-sam-file/">Directional RNA-seq— Part 1: SAM file flags</a>。下面表格解释四个数值的具体意义，其中<code class="language-bash">1</code>标识双端测序，<code class="language-bash">2</code>表示一对reads正确地map到基因组合适位置，表格中着重陈述<code class="language-bash">64</code>、<code class="language-bash">32</code>、<code class="language-bash">128</code>和<code class="language-bash">16</code>。</p>

<hr />

<table>
  <thead>
    <tr>
      <th>Flag</th>
      <th>Composition</th>
      <th>Explanation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>99</td>
      <td>64+32+2+1</td>
      <td>一对引物中第一个map到基因组正义链；第二个反方向map到基因组正义链</td>
    </tr>
    <tr>
      <td>147</td>
      <td>128+16+2+1</td>
      <td>一对引物中第二个反方向map基因组正义链；第一个map到基因组正义链</td>
    </tr>
    <tr>
      <td>83</td>
      <td>64+16+2+1</td>
      <td>一对引物中第一个map到基因组反义链；第二个反方向map到基因组反义链</td>
    </tr>
    <tr>
      <td>163</td>
      <td>128+32+2+1</td>
      <td>一对引物中第二个反方向map基因组正义链；第一个map到基因组正义链</td>
    </tr>
  </tbody>
</table>

<hr />

<p>之后，我们需要筛选含有这些flags的reads。由于我们通常需要操作bam文件，也希望输出是bam文件，中间过程不希望再重新生成sam文件。那么，就需要结合使用<code class="language-bash">awk</code>进行筛选，具体方法见本篇文章开头所示。当然，如果是只是查看，可以使用下面例子中的 <code class="language-bash">samtools view -f 0x2</code>。</p>

<p><figure class='code'><figcaption><span>Count number of unique pair-mapped alignments</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># map到基因组上唯一位置的reads数目</span>
</span><span class='line'><span class="nv">$ </span>samtools view -q <span class="m">50</span> accepted_hits.bam <span class="p">|</span> wc -l
</span><span class='line'>93044727
</span><span class='line'><span class="c"># 成对reads都map到基因组对应位置的reads数目</span>
</span><span class='line'><span class="nv">$ </span>samtools view -f 0x2 accepted_hits.bam <span class="p">|</span> wc -l
</span><span class='line'>88793640
</span><span class='line'><span class="c"># 成对且唯一mapped的reads数目</span>
</span><span class='line'><span class="nv">$ </span>samtools view -q <span class="m">50</span> -f 0x2 accepted_hits.bam <span class="p">|</span> wc -l
</span><span class='line'>79143942
</span></code></pre></td></tr></table></div></figure></p>

<h2 id="tophat">3. 操作TopHat输出的文件命令集锦</h2>

<p><figure class='code'><figcaption><span>Useful bash for bam files from TopHat</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># samtools的view -c命令，其实就是输出sam文件有多少行</span>
</span><span class='line'><span class="nv">$ </span>samtools view accepted_hits.bam <span class="p">|</span> wc -l
</span><span class='line'>109278388
</span><span class='line'><span class="nv">$ </span>samtools view -c accepted_hits.bam
</span><span class='line'>109278388&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;bammappedreads&quot;</span>&gt;查看bam文件中mapped的reads长度分布&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;# 第二种方法是运行FastQC，输出结果中也有显示
</span><span class='line'>samtools view accepted_hits.bam <span class="p">|</span> awk ‘<span class="o">{</span>print length<span class="o">(</span><span class="nv">$10</span><span class="o">)}</span>’ <span class="p">|</span> sort -n <span class="p">|</span> uniq -c&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;bed&quot;</span>&gt;查看bed文件前几行&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;<span class="nv">$ </span>head junction.bed
</span><span class='line'><span class="c"># 统计bed文件有多少行，需要去除第一行注释</span>
</span><span class='line'><span class="c"># 以下两种方式相同，但不够完美</span>
</span><span class='line'><span class="nv">$ </span>wc -l junction.bed
</span><span class='line'><span class="m">220648</span> junctions.bed
</span><span class='line'><span class="nv">$ </span>awk ‘END <span class="o">{</span>print NR<span class="o">}</span>’ junctions.bed
</span><span class='line'>220648
</span></code></pre></td></tr></table></div></figure></p>

<h2 id="dnamrna">4. DNA链和mRNA链的称呼总结</h2>

<p>双链DNA和单链mRNA，对每条链都有特定的称呼。总结如下：</p>

<p><figure class='code'><figcaption><span>DNA/RNA strands </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>3’~~~~~UCUGAU~~~~~ 5’ mRNA的对应基因信息在reverse strand&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;5’—–AGACTA———-ATTGTT—– 3’
</span><span class='line'>3’—–TCTGAT———-TAACAA—– 5’&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;            5<span class="s1">&#39;~~~~~AUUGUU~~~~~ 3&#39;</span> mRNA的对应基因信息在forward strand
</span></code></pre></td></tr></table></div></figure>
</code></pre>

<p>对于一条双链DNA，称呼列表如下：</p>

<table>
  <thead>
    <tr>
      <th>方向<sup>a</sup></th>
      <th>名称1</th>
      <th>名称2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>从左至右</td>
      <td>forward</td>
      <td>plus</td>
    </tr>
    <tr>
      <td>从右至左</td>
      <td>reverse</td>
      <td>minus</td>
    </tr>
  </tbody>
</table>

<p><sup>a</sup>：方向是指5’至3’的阅读方向，用于区分两条DNA链条</p>

<hr />

<p>对于一条RNA链，其对应的双链DNA称呼如下：</p>

<table>
  <thead>
    <tr>
      <th>mRNA方向<sup>a</sup></th>
      <th>名称1</th>
      <th>名称2</th>
      <th>名称3</th>
      <th>名称4</th>
      <th>名称5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>同向</td>
      <td>coding</td>
      <td>nontemplate</td>
      <td>sense</td>
      <td>positive</td>
      <td>+</td>
    </tr>
    <tr>
      <td>反向</td>
      <td>template</td>
      <td>noncoding</td>
      <td>antisense</td>
      <td>negative</td>
      <td>-</td>
    </tr>
  </tbody>
</table>

<p><sup>a</sup>：mRNA方向是指5’至3’。</p>

<hr />

<h3 id="section-1">参考网址</h3>

<ul>
  <li>
    <p><a href="http://blog.qiuworld.com:8080/archives/3321">关于map当中的unique mapped reads问题</a></p>
  </li>
  <li>
    <p>TopHat的bam输出文件第五列（类似MAPQ）的讨论： <a href="https://groups.google.com/forum/#!topic/tuxedo-tools-users/m0p1qXDEqKA">tophat mapping quality</a>和<a href="http://www.acgt.me/blog/2015/3/17/more-madness-with-mapq-scores-aka-why-bioinformaticians-hate-poor-and-incomplete-software-documentation">More madness with MAPQ scores</a></p>
  </li>
  <li>
    <p><a href="https://biobeat.wordpress.com/2013/05/01/directional-rna-seq-part-2-using-samtools/">Directional RNA-seq— Part 2: Explore SAM flags using samtools</a></p>
  </li>
  <li>
    <p><a href="http://www.acgt.me/blog/2015/4/15/filtering-a-sam-file-generated-by-tophat-to-find-uniquely-mapped-concordant-read-pairs-awk-vs-samtools">Filtering a SAM file generated by TopHat to find uniquely mapped, concordant read pairs: AWK vs SAMtools</a></p>
  </li>
  <li>
    <p><a href="https://www.biostars.org/p/3423/">Question: Forward And Reverse Strand Conventions</a></p>
  </li>
  <li>
    <p><a href="http://en.wikipedia.org/wiki/Sense_(molecular_biology)">wiki</a></p>
  </li>
</ul>

<h3 id="section-2">更新记录</h3>

<p>2015年5月25日</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[二代测序中的短序列比对]]></title>
    <link href="http://yulongniu.bionutshell.org/blog/2014/07/26/short-sequence-alignment/"/>
    <updated>2014-07-26T02:04:25+08:00</updated>
    <id>http://yulongniu.bionutshell.org/blog/2014/07/26/short-sequence-alignment</id>
    <content type="html"><![CDATA[<p>在二代测序数据分析中，非常重要的一步是将测得的短序列“对应”到基因组上。所使用的工具被称为“短序列比对工具（short sequence aligners）”。以下是一些常用工具的介绍。</p>

<h2 id="bowtie">1. Bowtie</h2>

<p><strong>简介</strong>：<a href="http://bowtie-bio.sourceforge.net/">Bowtie2</a>是现在广泛使用的序列比对工具。</p>

<p><strong>运行方式</strong>：所有平台</p>

<p><strong>特点</strong>：</p>

<ul>
  <li>
    <p>相比较<a href="http://bowtie-bio.sourceforge.net/index.shtml">Bowtie1</a>，处理大于50bp的短序列，速度更快、也更敏感。Bowtie1在处理小于50bp的短序列上，效果更好。</p>
  </li>
  <li>
    <p><a href="http://support.illumina.com/sequencing/sequencing_software/igenome.ilmn">iGenomes</a>提供一些事先编排（index）的基因组。
<!--more--></p>
  </li>
</ul>

<p><strong>快速运行</strong>：</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># 建立一系列FASTA文件目录</span>
</span><span class='line'><span class="nv">$ </span>bowtie2-build /filePath/genomeFastaFile indexName&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>&gt;从已经index文件中提取原始基因组&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;<span class="nv">$ </span>bowtie2-inspect indexName <span class="p">&amp;</span>gt<span class="p">;</span> genomeFastaFile&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;unpaired&quot;</span>&gt;unpaired序列比对&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;<span class="nv">$ </span>bowtie2 -p <span class="m">4</span> -x indexName -U readFiles -S samFileName&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;paired&quot;</span>&gt;paired序列比对&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;<span class="nv">$ </span>bowtie2 -p <span class="m">4</span> -x indexName  -1 readFiles1 -2 readFiles2 -S eg2.sam&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;
</span></code></pre></td></tr></table></div></figure></p>

<ul>
  <li>
    <p><code>-p</code>：多线程</p>
  </li>
  <li>
    <p><code>-x</code>：之后跟index名称</p>
  </li>
  <li>
    <p><code>-U</code>：测序文件（比如Fasta，Fastq文件）</p>
  </li>
  <li>
    <p><code>-1</code>/<code>-2</code>：标识paired文件</p>
  </li>
  <li>
    <p><code>-S</code>：SAM格式输出文件</p>
  </li>
</ul>

<h3 id="section">参考网址</h3>

<ul>
  <li><a href="http://lh3lh3.users.sourceforge.net/NGSalign.shtml">Heng Li总结的工具列表</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RNA-seq基本概念和数据分析流程]]></title>
    <link href="http://yulongniu.bionutshell.org/blog/2014/07/23/rna-seq-analysis/"/>
    <updated>2014-07-23T05:03:15+08:00</updated>
    <id>http://yulongniu.bionutshell.org/blog/2014/07/23/rna-seq-analysis</id>
    <content type="html"><![CDATA[<p>RNA-seq相比较基因芯片，价格虽然昂贵一些，精度和灵敏度更高。同时，在测序深度足够时，也可以检测mRNA选择性剪切类型。</p>

<h2 id="section">1. 样品制备</h2>

<!--more-->

<h2 id="section-1">2. 测序</h2>

<p>Illumina双端测序<a href="http://www.illumina.com/technology/next-generation-sequencing/paired-end-sequencing_assay.html">动画</a>和<a href="http://onetipperday.blogspot.sg/2013/12/illumina-hiseq2000-adapter-and.html">图示</a>。</p>

<h2 id="section-2">3. 分析流程</h2>

<p>RNA-seq<a href="http://blog.qiuworld.com:8080/archives/2343">主要分析流程</a>：</p>

<p><figure class='code'><figcaption><span>Workflow of RNA-seq data analysis </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>原始数据质量评估 –<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>数据清洗（去除接头和低质量read） –<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>清洗数据质量评估 –<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>map测序结果至基因组（转录组） –<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>map数据质量评估 –<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>差异表达基因/选择性剪切/新基因/融合基因选择 –<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>GO和pathway分析 –<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>共表达网络分析
</span></code></pre></td></tr></table></div></figure></p>

<h3 id="section-3">3.1 序列清洗</h3>

<p>序列清洗主要是去除测序结果中的<a href="http://onetipperday.blogspot.sg/2013/06/illumina-hiseq2000-adapter.html">adapter</a>或通用引物等。</p>

<p>以下使用Illumina HiSeq2000平台，对一个人类样本的RNA测序。统计各种序列清洗方法和选择后的reads数目。原始数据两端测序reads分别为54,492,228和54,492,228。</p>

<hr />

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>#Trimmed</th>
      <th>#Mapped*</th>
      <th>#Filtered</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>r50-notrim</td>
      <td>108,984,456</td>
      <td>109,278,388</td>
      <td>79,143,942</td>
    </tr>
    <tr>
      <td>r50-nomixed-notrim</td>
      <td>108,984,456</td>
      <td>103,548,800</td>
      <td>79,143,942</td>
    </tr>
    <tr>
      <td>r50-nomixed-trimmomatic-min20</td>
      <td>104,164,622</td>
      <td>116,315,394</td>
      <td>80,337,256</td>
    </tr>
    <tr>
      <td>r50-nomixed-trimmomatic-min36</td>
      <td>101,548,172</td>
      <td>110,778,108</td>
      <td>79,248,896</td>
    </tr>
    <tr>
      <td>r50-nomixed-trimmomatic-min50</td>
      <td>98,525,312</td>
      <td>106,659,988</td>
      <td>77,779,424</td>
    </tr>
    <tr>
      <td>r50-nomixed-galore-min20</td>
      <td>107,097,862</td>
      <td>114,943,386</td>
      <td>83,039,928</td>
    </tr>
    <tr>
      <td>r100-nomixed-galore-min20</td>
      <td>107,097,862</td>
      <td>114,944,672</td>
      <td>87,899,316</td>
    </tr>
    <tr>
      <td>r165sd45-nomixed-galore-min20</td>
      <td>107,097,862</td>
      <td>114,201,366</td>
      <td>90,750,208</td>
    </tr>
    <tr>
      <td>r165sd45G-nomixed-galore-min20</td>
      <td>107,097,862</td>
      <td>109,901,742</td>
      <td>93,477,122</td>
    </tr>
    <tr>
      <td>r165sd45-nomixed-galore-min50</td>
      <td>104,869,208</td>
      <td>109,258,544</td>
      <td>89,329,672</td>
    </tr>
  </tbody>
</table>

<p><strong>*</strong>：使用TopHat2把序列mapped到hs19基因组。TopHat2默认设置为，如果一个reads能mapped到多个位点，则都会报道。因此数目可能比原始数据多。</p>

<hr />

<h2 id="section-4">4. 分析过程注意事项</h2>

<ol>
  <li>参考转录组注释文件（GFF/GTF）的染色体编号，与基因组信息一致。比如都用<code class="language-bash">chr1</code>，或者都用<code class="language-bash">1</code>标识1号染色体。可能出现问题地方：</li>
</ol>

<blockquote>
  <ul>
    <li>
      <p><a href="http://ccb.jhu.edu/software/tophat/manual.shtml">TopHat</a>的<code class="language-bash">-G/--GTF</code>参数。</p>
    </li>
    <li>
      <p><a href="http://miso.readthedocs.org/en/fastmiso/#human-mouse-gene-models-for-isoform-centric-analyses">MISO</a>程序<code class="language-bash">pe_utils</code>的传入转录组注释文件。</p>
    </li>
  </ul>

</blockquote>

<h2 id="section-5">5. 基本概念</h2>

<ul>
  <li>
    <p><strong>Read</strong>：是组成测序的结果的基本单位。</p>
  </li>
  <li>
    <p><strong>Count</strong>：在某次测序中，对于某个指标（比如某个基因），得到的reads数的总和。</p>
  </li>
  <li>
    <p><strong>RPKM</strong>（Reads Per Kilobase per Million）和<strong>FPKM</strong>（Fragments Per Kilobase per Million）：</p>
  </li>
</ul>

<blockquote>
  <p>首先需要解释FPKM和RPKM的原理是相似的，区别在于FPKM对应的是DNA片段，比如在一个Illumina的pair-end（双尾）RNA-seq中，一对（两个）reads对应是一个DNA片段。有了FPKM（RPKM）概念，我们就能比较：同一个样本中基因A和基因B的相对表达量；或者不同样本中，同一个基因的相对表达量。</p>

  <p>具体的原因是：引入“每一千碱基（per kilobase）”的原因在于，不同的RNA可能有不同长度，长度越长，对应的reads就越多。当每个RNA都除以自身长度（以1000碱基为单位）时，就可以比较同一个样本中不同基因的相对表达量了。相似地，引入“每一百万reads”的原因是，不同的样本可能测序的深度不一样，深度越深，当然对应的reads就越多了。如果结果除以各自库的数量（以一百万reads为单位），那么我们就能很好地衡量两个不同样本中同一个基因的相对表达量。</p>
</blockquote>

<ul>
  <li>
    <p><strong>Alignment</strong>：确定测得的reads在基因组上的位置的过程。</p>
  </li>
  <li>
    <p><strong>Mapping</strong>：确定aligned reads对应的转录本。</p>
  </li>
  <li>
    <p><strong>Pair end (PE)</strong>和<strong>Mate-Pair (MP)</strong>：</p>
  </li>
</ul>

<blockquote>
  <p>两种双端测序的方法，主要区别在样品库制备和测序上。比如PE制备的库是adapter在目标序列两端，而MP库中adapter在目标序列中间。因此，在数据分析时，MP类型测序必须注意剔除adapter。具体参考<a href="http://seqanswers.com/forums/showthread.php?t=503">论坛讨论</a>和<a href="http://scottmyourstone.blogspot.sg/2013/11/difference-between-paired-end-and-mate.html">Difference Between Paired-End and Mate-Pair Reads</a>。</p>

  <p>在序列软件软件中，有时也称呼一对测序reads（对同一个目标片段分别测得的正义链和反义链），它们互为mate，分别存在两个对应的测序结果文件中。</p>
</blockquote>

<ul>
  <li><strong>Adapter（接头）</strong>、<strong>Barcode（标签）</strong>和<strong>Insert（插入片段）</strong>：</li>
</ul>

<blockquote>
  <p>adapter是一段短的序列已知的核酸链，用于链接序列未知的目标测序片段。</p>

  <p>barcode，也称为index，是一段很短的寡居核酸链，用于在多个样品混合测序时，标记不同的样品。
insert是用于测序的目标片段，因为是包括在两个adapter之间，所以被称为“插入”片段。</p>

  <p>一个常见测序片段类似与<code class="language-bash">adapter--barcode--insert--adapter</code>。测序开始时前几个碱基无法测得，第一个adapter在数据输出时被去除；由于测序仪读长限制，第二个adapter通常无法测得。所以，经常得到类似 <code class="language-bash">barcode--部分insert</code>的read。最后，把barcode去除，只保留测度insert的片段，这个操作的术语是demultiplexing。</p>

  <p>需要注意的是，<a href="http://www.illumina.com/documents/products/datasheets/datasheet_truseq_sample_prep_kits.pdf">Illumina TruSeq</a>样品库制备方法中，barcode是在adapter中部，而且是与insert分开测序。而<a href="http://res.illumina.com/documents/products/technotes/technote_nextera_matepair_data_processing.pdf">Illumina Nextera Mate Pair</a>样品库制备中，adapter在目标序列中部。</p>
</blockquote>

<ul>
  <li>
    <p><strong>Concordant Pairs</strong>和<strong>Discordant Pairs</strong>：根据<a href="http://bowtie-bio.sourceforge.net/bowtie2/manual.shtml#paired-inputs">Bowtie2</a>的解释，concordant pairs表示一对reads在alignment时，既方向匹配又有合适距离（Bowtie2中是200bp～500bp）。如果上述方向和距离，任意一个条件不满足，则称为discordant pairs。</p>
  </li>
  <li>
    <p><strong>chrN_random</strong>和<strong>chrUn</strong>：基因组文件中通常含有类似<code class="language-bash">chr9_gl000198_random</code>和<code class="language-bash">chrUn_gl000211</code>的基因组。根据<a href="https://genome.ucsc.edu/FAQ/FAQdownloads.html#download11">UCSC</a>解释，<code class="language-bash">chrN_random</code>包括基因组已知但具体位置未知序列，或者位置已知但具体内容未完成序列。<code class="language-bash">ChrUn</code>中包括一些具体位置未知的序列。</p>
  </li>
  <li>
    <p><strong>chrN_xxx_hap1</strong>：转录组注释文件中会出现类似<code class="language-bash">chr6_apd_hap1</code>和<code class="language-bash">chr6_dbb_hap3</code>的基因组注释。根据<a href="http://genome.ucsc.edu/cgi-bin/hgGateway?org=Human&amp;db=hg19">UCSC解释</a>这些基因组是[单倍型(haplotype)]基因组(http://hapmap.ncbi.nlm.nih.gov/originhaplotype.html.en)。</p>
  </li>
</ul>

<h3 id="section-6">参考网址</h3>

<ul>
  <li>
    <p>推荐幻灯片<a href="http://www.slideshare.net/mikaelhuss/all-bio-rnaseqqc?from_action=save">RNA-seq quality control and pre-processing</a></p>
  </li>
  <li>
    <p><a href="http://faculty.ucr.edu/~tgirke/HTML_Presentations/Manuals/Workshop_Dec_12_16_2013/Rrnaseq/Rrna">Bioconductor详细流程</a></p>
  </li>
  <li>
    <p>RPKM和FPKM：<a href="http://jefworks.com/rpkm-and-fpkm-explained/">1</a>、 <a href="http://www.cureffi.org/2013/09/12/counts-vs-fpkms-in-rna-seq/">2</a>和<a href="http://www.partek.com/Tutorials/microarray/User_Guides/UnderstandingReads.pdf">3一个计算RPKM的例子</a></p>
  </li>
  <li>
    <p>ENCODE推荐的RNA-seq数据分析指导 <a href="http://genome.ucsc.edu/ENCODE/protocols/dataStandards/ENCODE_RNAseq_Standards_V1.0.pdf">The ENCODE Consortium: Standards, Guidelines and Best Practices for RNA-seq</a></p>
  </li>
  <li>
    <p>RNA-seq差异表达分析工作流程：<a href="http://216.49.144.90:8080/archives/3007/comment-page-2">中文</a>，<a href="http://vallandingham.me/RNA_seq_differential_expression.html">英文</a></p>
  </li>
  <li>
    <p><a href="http://www.rna-seqblog.com/how-many-reads-are-enough/">多少个read才够</a></p>
  </li>
  <li>
    <p><a href="http://www.macrogencn.com/_d275872179.htm">高通量测序常用名词汇总</a></p>
  </li>
  <li>
    <p><a href="http://bowtie-bio.sourceforge.net/bowtie2/manual.shtml#paired-inputs">Bowtie2对一些常用名词解释</a></p>
  </li>
  <li>
    <p><a href="http://www.plob.org/2014/11/09/8672.html">二代测序中barcodes index的介绍</a></p>
  </li>
  <li>
    <p>Illumina样品制备参考：<a href="https://www.med.unc.edu/pharm/calabreselab/files/tufts-sequencing-primer">Illumina TruSeq DNA Adapters De-Mystified</a>和<a href="http://bioinformatics.cvr.ac.uk/blog/illumina-adapter-and-primer-sequences/">Illumina adapter and primer sequences</a></p>
  </li>
  <li>
    <p><a href="http://www.research.janahang.com/quality-control-and-trimming-of-rna-seq-data/">Quality Control and Trimming of RNA-seq data</a></p>
  </li>
  <li>
    <p><a href="http://cgrlucb.wikispaces.com/file/view/readMapping.pdf">Best Practices and Suggestions for Read Alignment</a></p>
  </li>
  <li>
    <p><a href="http://barcwiki.wi.mit.edu/wiki/SOPs/rna-seq-diff-expressions">Using RNA-seq to quantify gene levels and assay for differential expression</a></p>
  </li>
</ul>

<h3 id="section-7">更新记录</h3>

<p>2015年5月19日</p>
]]></content>
  </entry>
  
</feed>
